name: Build AGTR Anti-Cheat DLL

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup VS Dev Environment
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x86
    
    - name: Build winmm.dll
      run: |
        cd src
        cl /O2 /MT /LD /EHsc /W3 agtr_winmm.cpp /link /DEF:winmm.def /OUT:winmm.dll winmm.lib winhttp.lib ws2_32.lib iphlpapi.lib psapi.lib advapi32.lib bcrypt.lib crypt32.lib user32.lib gdi32.lib gdiplus.lib shell32.lib ole32.lib
      shell: cmd
    
    - name: Build dinput8.dll
      run: |
        cd src
        cl /O2 /MT /LD /EHsc /W3 agtr_dinput8.cpp /link /DEF:dinput8.def /OUT:dinput8.dll dinput8.lib user32.lib
      shell: cmd
      continue-on-error: true
    
    - name: Build dsound.dll
      run: |
        cd src
        cl /O2 /MT /LD /EHsc /W3 agtr_dsound.cpp /link /DEF:dsound.def /OUT:dsound.dll dsound.lib user32.lib
      shell: cmd
      continue-on-error: true
    
    - name: Upload DLL Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: agtr-anticheat-dlls
        path: |
          src/winmm.dll
          src/dinput8.dll
          src/dsound.dll
        retention-days: 30
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          src/winmm.dll
          src/dinput8.dll
          src/dsound.dll
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
